<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π</title>
  <link rel="stylesheet" href="styles/teacher.css?v=4" />
  <script src="scripts/auth.js"></script>
</head>

<body>
  <header>
    <div class="inner">
      <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå</h1>
    </div>
  </header>

  <main class="page">
    <section class="card">
      <div class="card-head">
        <h2>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
        <div class="badge" id="facultyName"></div>
      </div>

      <form id="scoreForm" class="form-grid">
        <div class="field">
          <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
          <select id="classroom" class="control" required></select>
        </div>

        <div class="field">
          <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</label>
          <select id="scoreType" class="control" required>
            <option value="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢</option>
            <option value="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î</option>
            <option value="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß</option>
          </select>
        </div>

        <div class="field">
          <label id="scoreLabel">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</label>
          <input
            type="number"
            id="scoreValue"
            class="control"
            required
            placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"
            min="0"
            inputmode="numeric"
          />
        </div>

        <div class="field">
          <label>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
          <input type="file" id="activityImage" class="control" accept="image/*" />
        </div>

        <div class="actions">
          <button type="submit" class="btn primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
          <button type="button" class="btn ghost" id="resetBtn">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          <button type="button" class="btn ghost" id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <p id="msg" class="msg"></p>
      </form>
    </section>

    <section class="card">
      <div class="card-head">
        <h2>üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h2>
        <p class="sub">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</p>
      </div>

      <div class="table-wrap">
        <table id="historyTable">
          <thead>
            <tr>
              <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏Ñ‡∏ì‡∏∞‡∏™‡∏µ</th>
              <th>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
              <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
              <th>‡∏Ñ‡πà‡∏≤</th>
              <th>‡∏£‡∏π‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="imagePopup" onclick="closePopup()">
    <img id="popupImage" src="" alt="‡∏£‡∏π‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°" />
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // =========================
    // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏£‡∏π
    // =========================
    localStorage.setItem("isTeacher", "1");

    // =========================
    // Firebase Config
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyDwmeumgDSVlspe7gIcF6rVbe-hBye7Q3I",
      authDomain: "school-scores-8e9eb.firebaseapp.com",
      databaseURL: "https://school-scores-8e9eb-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "school-scores-8e9eb",
      storageBucket: "school-scores-8e9eb.firebasestorage.app",
      messagingSenderId: "416720346956",
      appId: "1:416720346956:web:b20e84af0b635b374279e9",
      measurementId: "G-DD7E1RFNC1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // =========================
    // ‡∏Ñ‡∏£‡∏π‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ currentFaculty
    // =========================
    const faculty = (localStorage.getItem("currentFaculty") || "").trim();

    if (!faculty) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ì‡∏∞‡∏™‡∏µ/‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π‡∏Å‡πà‡∏≠‡∏ô");
      window.location.href = "select-faculty.html";
    }

    document.getElementById("facultyName").innerText = faculty || "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ì‡∏∞";

    // =========================
    // ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ì‡∏∞ (‡∏°‡∏≤‡∏à‡∏≤‡∏Å auth.js)
    // =========================
    const classroomSelect = document.getElementById("classroom");
    classroomSelect.innerHTML = "";

    if (typeof facultyClassroom !== "undefined" && facultyClassroom[faculty]) {
      facultyClassroom[faculty].forEach(room => {
        const opt = document.createElement("option");
        opt.value = room;
        opt.textContent = room;
        classroomSelect.appendChild(opt);
      });
    } else {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
      classroomSelect.appendChild(opt);
    }

    // =========================
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô label/placeholder ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    // =========================
    const scoreTypeEl = document.getElementById("scoreType");
    const scoreLabelEl = document.getElementById("scoreLabel");
    const scoreValueEl = document.getElementById("scoreValue");

    function syncScoreLabel() {
      const type = scoreTypeEl.value;
      if (type === "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢") {
        scoreLabelEl.innerText = "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢:";
        scoreValueEl.placeholder = "‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏™‡∏≤‡∏¢";
      } else if (type === "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î") {
        scoreLabelEl.innerText = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î:";
        scoreValueEl.placeholder = "‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î";
      } else {
        scoreLabelEl.innerText = "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß:";
        scoreValueEl.placeholder = "‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß";
      }
    }

    scoreTypeEl.addEventListener("change", syncScoreLabel);
    syncScoreLabel();

    // =========================
    // UI helper
    // =========================
    function showMsg(text) {
      const el = document.getElementById("msg");
      el.innerText = text;
      if (text) setTimeout(() => { el.innerText = ""; }, 1500);
    }

    // =========================
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏™‡πà‡∏á teacherKey ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô Rules)
    // =========================
    const TEACHER_KEY = "SNS_TEACHER_2026";

    async function saveHistory(payload) {
      try {
        await db.ref("scores").push(payload);
        scoreValueEl.value = "";
        document.getElementById("activityImage").value = "";
        showMsg("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ");
      } catch (err) {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
      }
    }

    document.getElementById("scoreForm").addEventListener("submit", function (event) {
      event.preventDefault();

      const classroom = classroomSelect.value;
      const type = scoreTypeEl.value;
      const raw = scoreValueEl.value;
      const value = Number(raw);

      // ‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î
      if (!Number.isFinite(value) || value < 0) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (0 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)");
        return;
      }

      const time = new Date().toLocaleString("th-TH");
      const fileInput = document.getElementById("activityImage");

      const basePayload = {
        faculty,
        classroom,
        type,
        value,
        time,
        image: "",
        teacherKey: TEACHER_KEY
      };

      if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          basePayload.image = e.target.result;
          saveHistory(basePayload);
        };
        reader.readAsDataURL(fileInput.files[0]);
      } else {
        saveHistory(basePayload);
      }
    });

    // =========================
    // ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏ï‡∏¥‡∏î listener ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
    // =========================
    function renderHistory() {
      const tbody = document.querySelector("#historyTable tbody");
      db.ref("scores")
        .orderByChild("faculty")
        .equalTo(faculty)
        .on("value", (snapshot) => {
          const data = snapshot.val() || {};
          tbody.innerHTML = "";

          Object.keys(data).forEach((key) => {
            const item = data[key];
            const row = document.createElement("tr");

            const displayValue =
              item.type === "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢"
                ? `${item.value ?? 0} ‡∏Ñ‡∏ô`
                : `${item.value ?? 0} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`;

            row.innerHTML = `
              <td>${item.time || "-"}</td>
              <td>${item.faculty || "-"}</td>
              <td>${item.classroom || "-"}</td>
              <td>${item.type || "-"}</td>
              <td>${displayValue}</td>
              <td>${item.image ? `<img src="${item.image}" class="activity-img" onclick="openImagePopup('${item.image}')">` : "-"}</td>
            `;
            tbody.appendChild(row);
          });
        });
    }

    // =========================
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ì‡∏∞‡∏ô‡∏µ‡πâ
    // =========================
    async function resetHistory() {
      if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ì‡∏∞‡∏ô‡∏µ‡πâ?")) return;

      try {
        const snap = await db.ref("scores").orderByChild("faculty").equalTo(faculty).once("value");
        const updates = {};
        snap.forEach((child) => {
          // ‡∏•‡∏ö‡πÅ‡∏ö‡∏ö multi-path ‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤ remove ‡∏ó‡∏µ‡∏•‡∏∞‡∏≠‡∏±‡∏ô
          updates["scores/" + child.key] = null;
        });
        await db.ref().update(updates);
        showMsg("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ");
      } catch (err) {
        alert("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
      }
    }

    document.getElementById("resetBtn").addEventListener("click", resetHistory);

    // =========================
    // Popup ‡∏£‡∏π‡∏õ
    // =========================
    function openImagePopup(src) {
      document.getElementById("popupImage").src = src;
      document.getElementById("imagePopup").style.display = "block";
    }

    function closePopup() {
      document.getElementById("imagePopup").style.display = "none";
    }

    window.openImagePopup = openImagePopup;
    window.closePopup = closePopup;

    // =========================
    // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏£‡∏π)
    // =========================
    function logoutTeacher() {
      localStorage.removeItem("isTeacher");
      // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏ì‡∏∞‡∏î‡πâ‡∏ß‡∏¢ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
      // localStorage.removeItem("currentFaculty");
      window.location.href = "role.html";
    }

    document.getElementById("logoutBtn").addEventListener("click", logoutTeacher);

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    renderHistory();
  </script>

  <footer>
    <div class="inner">
      <p>¬© ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå | <a href="select-faculty.html">‡∏î‡∏π‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏™‡∏µ</a></p>
    </div>
  </footer>
</body>
</html>

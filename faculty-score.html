<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>คะแนนคณะสี</title>
  <link rel="stylesheet" href="styles/faculty-score.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>
  <header>
    <h1 id="facultyTitle">คะแนนคณะสี</h1>
  </header>

  <main>
    <!-- ตารางแยกตามประเภท -->
    <section>
      <h2>จำนวนคนมาสาย</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>เวลา</th>
              <th>ห้องเรียน</th>
              <th>คน</th>
              <th>รูปกิจกรรม</th>
              <th>แก้ไขคะแนน</th>
            </tr>
          </thead>
          <tbody id="lateTable"></tbody>
        </table>
      </div>
    </section>

    <section>
      <h2>คะแนนการเข้าแถว</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>เวลา</th>
              <th>ห้องเรียน</th>
              <th>คะแนน</th>
              <th>รูปกิจกรรม</th>
              <th>แก้ไขคะแนน</th>
            </tr>
          </thead>
          <tbody id="lineTable"></tbody>
        </table>
      </div>
    </section>

    <section>
      <h2>คะแนนความสะอาด</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>เวลา</th>
              <th>ห้องเรียน</th>
              <th>คะแนน</th>
              <th>รูปกิจกรรม</th>
              <th>แก้ไขคะแนน</th>
            </tr>
          </thead>
          <tbody id="cleanTable"></tbody>
        </table>
      </div>
    </section>

    <!-- สรุปคะแนนรวม -->
    <div class="summary" id="summaryBox"></div>
  </main>

  <div class="action-buttons">
    <button class="back-btn" onclick="window.location.href='summary.html'">
      สรุปผลคณะยอดเยี่ยมประจำสัปดาห์
    </button>
  </div>

  <footer>
    <p>© โรงเรียนสตรีนครสวรรค์ | <a href="select-faculty.html">หน้าเลือกคณะ</a></p>
  </footer>

  <!-- popup รูป -->
  <div id="imagePopup" onclick="closePopup()">
    <img id="popupImage" src="" alt="รูปกิจกรรม" />
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // =========================
    // Firebase Config
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyDwmeumgDSVlspe7gIcF6rVbe-hBye7Q3I",
      authDomain: "school-scores-8e9eb.firebaseapp.com",
      databaseURL:
        "https://school-scores-8e9eb-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "school-scores-8e9eb",
      storageBucket: "school-scores-8e9eb.firebasestorage.app",
      messagingSenderId: "416720346956",
      appId: "1:416720346956:web:b20e84af0b635b374279e9",
      measurementId: "G-DD7E1RFNC1",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // =========================
    // รับค่าคณะสีจาก URL
    // =========================
    const params = new URLSearchParams(window.location.search);
    const facultyName = (params.get("faculty") || "").trim();
    document.getElementById("facultyTitle").innerText =
      "คะแนนคณะสี " + (facultyName || "-");

    // =========================
    // ค่าคงที่
    // =========================
    const FACULTIES = ["มาลัยพิรุณ", "ไพจิตเวหาส", "โอภาสรวี", "จันทราอำไพ", "รัศมีดารา"];

    const CLASSROOMS = {
      "มาลัยพิรุณ": ["1/4","1/9","2/5","2/10","3/1","3/6","3/11","4/1","4/6","4/11","5/2","5/12","6/2","6/7","6/12"],
      "ไพจิตเวหาส": ["1/5","1/10","2/1","2/6","2/11","3/2","3/7","3/12","4/2","4/12","5/3","5/8","6/3","6/8","6/11"],
      "โอภาสรวี": ["1/1","1/6","1/11","2/2","2/7","3/3","3/8","4/3","4/8","4/13","5/4","5/9","5/11","6/4","6/9"],
      "จันทราอำไพ": ["1/3","1/8","1/13","2/4","2/9","3/5","3/10","4/5","4/7","4/10","5/1","5/6","6/5","6/6","6/13"],
      "รัศมีดารา": ["1/2","1/7","1/12","2/3","2/8","2/13","3/4","3/9","4/4","4/9","5/5","5/7","5/10","5/13","6/1","6/10"],
    };

    const TYPE_LATE = "คะแนนมาสาย";
    const TYPE_LINEUP = "คะแนนการเข้าแถว";
    const TYPE_CLEAN = "คะแนนความสะอาด";
    const LATE_RANK_SCORES = [9, 8, 7, 6, 5];

    let totalsByType = {
      [TYPE_LATE]: 0,
      [TYPE_LINEUP]: 0,
      [TYPE_CLEAN]: 0,
    };

    // =========================
    // Popup รูปภาพ
    // =========================
    function openImagePopup(src) {
      document.getElementById("popupImage").src = src;
      document.getElementById("imagePopup").style.display = "block";
    }

    function closePopup() {
      document.getElementById("imagePopup").style.display = "none";
    }

    window.openImagePopup = openImagePopup;
    window.closePopup = closePopup;

    // =========================
    // แก้ไขคะแนน
    // =========================
    function editScore(key, oldValue) {
      const newValue = prompt("แก้ไขคะแนน:", oldValue);
      if (newValue !== null && !isNaN(newValue)) {
        db.ref("scores/" + key).update({ value: Number(newValue) });
        alert("แก้ไขคะแนนเรียบร้อยแล้ว ✅");
      }
    }
    window.editScore = editScore;

    // =========================
    // สรุปคะแนนรวมด้านล่าง
    // =========================
    function updateSummary() {
      const summaryBox = document.getElementById("summaryBox");
      summaryBox.innerHTML = "";

      Object.keys(totalsByType).forEach((type) => {
        const card = document.createElement("div");
        card.className = "summary-card";
        const val = Number(totalsByType[type]) || 0;
        card.innerHTML = `<h3>${type}</h3><p>${val.toFixed(2)} คะแนน</p>`;
        summaryBox.appendChild(card);
      });

      const total =
        (Number(totalsByType[TYPE_LATE]) || 0) +
        (Number(totalsByType[TYPE_LINEUP]) || 0) +
        (Number(totalsByType[TYPE_CLEAN]) || 0);

      const totalCard = document.createElement("div");
      totalCard.className = "summary-card total";
      totalCard.innerHTML = `<h3>คะแนนรวมทั้งหมด</h3><p>${total.toFixed(2)} คะแนน</p>`;
      summaryBox.appendChild(totalCard);
    }

    // =========================
    // ดึงข้อมูลคะแนนจาก Firebase
    // =========================
    db.ref("scores").on("value", (snapshot) => {
      const data = snapshot.val() || {};

      // reset ตาราง
      const lateTbody = document.getElementById("lateTable");
      const lineTbody = document.getElementById("lineTable");
      const cleanTbody = document.getElementById("cleanTable");

      lateTbody.innerHTML = "";
      lineTbody.innerHTML = "";
      cleanTbody.innerHTML = "";

      // ✅ นับมาสายของทุกคณะ เพื่อจัดอันดับ (ใช้ทั้งระบบ)
      const lateCounts = {};
      const lateHasData = {};
      FACULTIES.forEach((f) => {
        lateCounts[f] = 0;
        lateHasData[f] = false;
      });

      let lineupTotalThis = 0;
      let cleanTotalThis = 0;

      // =========================
      // วนข้อมูลทั้งหมด
      // =========================
      for (const key in data) {
        const item = data[key] || {};
        const f = (item.faculty || "").trim();
        const v = Number(item.value) || 0;

        // เก็บจำนวนมาสายของทุกคณะ (เพื่อจัดอันดับ)
        if (item.type === TYPE_LATE && FACULTIES.includes(f)) {
          lateCounts[f] += v;
          lateHasData[f] = true;
        }

        // แสดงเฉพาะคณะของหน้านี้
        if (!facultyName || f !== facultyName) continue;

        if (item.type === TYPE_LATE) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.time || "-"}</td>
            <td>${item.classroom || "-"}</td>
            <td>${v} คน</td>
            <td>${
              item.image
                ? `<img src="${item.image}" class="activity-img" onclick="openImagePopup('${item.image}')">`
                : "-"
            }</td>
            <td><button onclick="editScore('${key}', ${v})">แก้ไข</button></td>
          `;
          lateTbody.appendChild(row);
        } else if (item.type === TYPE_LINEUP) {
          lineupTotalThis += v;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.time || "-"}</td>
            <td>${item.classroom || "-"}</td>
            <td>${v}</td>
            <td>${
              item.image
                ? `<img src="${item.image}" class="activity-img" onclick="openImagePopup('${item.image}')">`
                : "-"
            }</td>
            <td><button onclick="editScore('${key}', ${v})">แก้ไข</button></td>
          `;
          lineTbody.appendChild(row);
        } else if (item.type === TYPE_CLEAN) {
          cleanTotalThis += v;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.time || "-"}</td>
            <td>${item.classroom || "-"}</td>
            <td>${v}</td>
            <td>${
              item.image
                ? `<img src="${item.image}" class="activity-img" onclick="openImagePopup('${item.image}')">`
                : "-"
            }</td>
            <td><button onclick="editScore('${key}', ${v})">แก้ไข</button></td>
          `;
          cleanTbody.appendChild(row);
        }
      }

      // =========================
      // ✅ คำนวณ "คะแนนมาสาย" แบบอันดับ 9-5
      // - ถ้ายังไม่มีข้อมูลมาสายเลยทั้งระบบ -> 0
      // =========================
      let lateScoreThis = 0;
      const hasAnyLateData = FACULTIES.some((f) => lateHasData[f] === true);

      if (hasAnyLateData && FACULTIES.includes(facultyName)) {
        const sortedByLate = FACULTIES
          .map((f) => [f, lateHasData[f] ? lateCounts[f] : Number.POSITIVE_INFINITY])
          .sort((a, b) => a[1] - b[1]);

        const idx = sortedByLate.findIndex(([f]) => f === facultyName);
        lateScoreThis = LATE_RANK_SCORES[Math.min(idx, LATE_RANK_SCORES.length - 1)];
      }

      // =========================
      // คะแนนความสะอาด = เฉลี่ยตามจำนวนห้องของคณะนั้น
      // =========================
      const roomCount = CLASSROOMS[facultyName]?.length || 0;
      const cleanAvgThis = roomCount > 0 ? cleanTotalThis / roomCount : 0;

      totalsByType[TYPE_LATE] = lateScoreThis;
      totalsByType[TYPE_LINEUP] = lineupTotalThis;
      totalsByType[TYPE_CLEAN] = cleanAvgThis;

      updateSummary();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>р╕кр╕гр╕╕р╕Ыр╕Ьр╕ер╕Др╕Ур╕░р╕вр╕нр╕Фр╣Ар╕вр╕╡р╣Ир╕вр╕бр╕Ыр╕гр╕░р╕Ир╕│р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣М</title>
  <link rel="stylesheet" href="styles/summary.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <header>
    <h1>р╕кр╕гр╕╕р╕Ыр╕Ьр╕ер╕Др╕Ур╕░р╕вр╕нр╕Фр╣Ар╕вр╕╡р╣Ир╕вр╕бр╕Ыр╕гр╕░р╕Ир╕│р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣М</h1>
  </header>

  <main>
    <!-- тЬЕ р╕Бр╕ер╣Ир╕нр╕Зр╕Ыр╕гр╕░р╕Бр╕▓р╕ир╕Ьр╕╣р╣Йр╕Кр╕Щр╕░ (р╕Ир╕░р╣Др╕бр╣Ир╣Вр╕Фр╕Щ JS р╕Чр╕▒р╕Ър╣Бр╕ер╣Йр╕з) -->
    <div id="winnerBox" class="winner-box">
      <div class="winner-hero" id="winnerHero" style="display:none;">
        <div class="trophy">ЁЯПЖ</div>

        <div class="winner-text">
          <div class="title">р╕Др╕Ур╕░р╕кр╕╡р╕вр╕нр╕Фр╣Ар╕вр╕╡р╣Ир╕вр╕бр╕Ыр╕гр╕░р╕Ир╕│р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣М</div>
          <div class="name" id="winnerName">-</div>
          <div class="score" id="winnerScore">р╕Др╕░р╣Бр╕Щр╕Щр╕гр╕зр╕б -</div>
        </div>
      </div>

      <!-- тЬЕ р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Бр╕гр╕Ур╕╡р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕е -->
      <div id="winnerEmpty" class="winner-empty" style="display:none;">
        р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Др╕░р╣Бр╕Щр╕Щр╣Гр╕Щр╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣Мр╕Щр╕╡р╣Й
      </div>
    </div>

    <table id="summaryTable">
      <thead>
        <tr>
          <th>р╕Др╕Ур╕░р╕кр╕╡</th>
          <th>р╕Др╕░р╣Бр╕Щр╕Щр╕гр╕зр╕б</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <footer>
    <p>┬й р╣Вр╕гр╕Зр╣Ар╕гр╕╡р╕вр╕Щр╕кр╕Хр╕гр╕╡р╕Щр╕Др╕гр╕кр╕зр╕гр╕гр╕Др╣М | <a href="report.html">р╕Юр╕┤р╕бр╕Юр╣Мр╕гр╕▓р╕вр╕Зр╕▓р╕Щ</a></p>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDwmeumgDSVlspe7gIcF6rVbe-hBye7Q3I",
      authDomain: "school-scores-8e9eb.firebaseapp.com",
      databaseURL: "https://school-scores-8e9eb-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "school-scores-8e9eb",
      storageBucket: "school-scores-8e9eb.firebasestorage.app",
      messagingSenderId: "416720346956",
      appId: "1:416720346956:web:b20e84af0b635b374279e9",
      measurementId: "G-DD7E1RFNC1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const FACULTIES = ["р╕бр╕▓р╕ер╕▒р╕вр╕Юр╕┤р╕гр╕╕р╕У","р╣Др╕Юр╕Ир╕┤р╕Хр╣Ар╕зр╕лр╕▓р╕к","р╣Вр╕нр╕ар╕▓р╕кр╕гр╕зр╕╡","р╕Ир╕▒р╕Щр╕Чр╕гр╕▓р╕нр╕│р╣Др╕Ю","р╕гр╕▒р╕ир╕бр╕╡р╕Фр╕▓р╕гр╕▓"];

    const CLASSROOMS = {
      "р╕бр╕▓р╕ер╕▒р╕вр╕Юр╕┤р╕гр╕╕р╕У": ["1/4","1/9","2/5","2/10","3/1","3/6","3/11","4/1","4/6","4/11","5/2","5/12","6/2","6/7","6/12"],
      "р╣Др╕Юр╕Ир╕┤р╕Хр╣Ар╕зр╕лр╕▓р╕к": ["1/5","1/10","2/1","2/6","2/11","3/2","3/7","3/12","4/2","4/12","5/3","5/8","6/3","6/8","6/11"],
      "р╣Вр╕нр╕ар╕▓р╕кр╕гр╕зр╕╡": ["1/1","1/6","1/11","2/2","2/7","3/3","3/8","4/3","4/8","4/13","5/4","5/9","5/11","6/4","6/9"],
      "р╕Ир╕▒р╕Щр╕Чр╕гр╕▓р╕нр╕│р╣Др╕Ю": ["1/3","1/8","1/13","2/4","2/9","3/5","3/10","4/5","4/7","4/10","5/1","5/6","6/5","6/6","6/13"],
      "р╕гр╕▒р╕ир╕бр╕╡р╕Фр╕▓р╕гр╕▓": ["1/2","1/7","1/12","2/3","2/8","2/13","3/4","3/9","4/4","4/9","5/5","5/7","5/10","5/13","6/1","6/10"]
    };

    const TYPE_LATE = "р╕Др╕░р╣Бр╕Щр╕Щр╕бр╕▓р╕кр╕▓р╕в";
    const TYPE_LINEUP = "р╕Др╕░р╣Бр╕Щр╕Щр╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╣Бр╕Цр╕з";
    const TYPE_CLEAN = "р╕Др╕░р╣Бр╕Щр╕Щр╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Ф";
    const LATE_RANK_SCORES = [9, 8, 7, 6, 5];

    // =========================================================
    // тЬЕ р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣Мр╣Бр╕Ър╕Ъ "р╕зр╕▒р╕Щр╕нр╕▓р╕Чр╕┤р╕Хр╕вр╣М 00:00"
    // =========================================================
    function getSundayStartMs(now = new Date()) {
      const d = new Date(now);
      const day = d.getDay(); // 0 = р╕нр╕▓р╕Чр╕┤р╕Хр╕вр╣М
      d.setDate(d.getDate() - day);
      d.setHours(0, 0, 0, 0);
      return d.getTime();
    }

    function makeHistoryKey() {
      const pad = (n) => String(n).padStart(2, "0");
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}`;
    }

    async function weeklyResetIfNeeded() {
      const currentWeekStart = getSundayStartMs();

      const weekStartRef = db.ref("meta/weekStart");

      // transaction р╕Бр╕▒р╕Щр╕гр╕╡р╕Лр╣Йр╕│р╕Ир╕▓р╕Бр╕лр╕ер╕▓р╕вр╕Др╕Щ
      const tx = await weekStartRef.transaction((saved) => {
        if (!saved) return currentWeekStart;
        if (saved === currentWeekStart) return;
        return currentWeekStart;
      });

      if (!tx.committed) return;

      // р╕Бр╕▒р╕Щр╕Лр╣Йр╕│р╣Гр╕Щр╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╣Ар╕Фр╕╡р╕вр╕з
      const localKey = "lastWeekStartSeen";
      const lastSeen = Number(localStorage.getItem(localKey) || 0);
      if (lastSeen === currentWeekStart) return;
      localStorage.setItem(localKey, String(currentWeekStart));

      // р╕Бр╕▒р╕Щр╕Лр╣Йр╕│р╕Чр╕▒р╣Йр╕Зр╕гр╕░р╕Ър╕Ър╕Фр╣Йр╕зр╕в flag
      const resetFlagRef = db.ref("meta/lastResetWeekStart");
      const flagSnap = await resetFlagRef.get();
      const lastResetWeekStart = flagSnap.val();

      if (lastResetWeekStart === currentWeekStart) return;

      // р╕вр╣Йр╕▓р╕в scores р╣Др╕Ы history р╣Бр╕ер╣Йр╕зр╕ер╣Йр╕▓р╕З
      const scoresSnap = await db.ref("scores").get();
      const scoresData = scoresSnap.val() || {};

      const historyKey = makeHistoryKey();
      await db.ref(`scores_history/${historyKey}`).set({
        weekStart: currentWeekStart,
        movedAt: Date.now(),
        scores: scoresData
      });

      await db.ref("scores").remove();
      await resetFlagRef.set(currentWeekStart);

      console.log("тЬЕ р╕гр╕╡р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣Мр╣Гр╕лр╕бр╣Ир╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в (р╣Ар╕гр╕┤р╣Ир╕бр╕зр╕▒р╕Щр╕нр╕▓р╕Чр╕┤р╕Хр╕вр╣М 00:00)");
    }

    // р╣Ар╕гр╕╡р╕вр╕Бр╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕Бр╣Ир╕нр╕Щр╣Ар╕гр╕┤р╣Ир╕бр╕Яр╕▒р╕З scores
    weeklyResetIfNeeded().catch(err => console.error("weeklyResetIfNeeded error:", err));

    // =========================================================
    // ЁЯФ╗ р╣Вр╕Др╣Йр╕Фр╕кр╕гр╕╕р╕Ыр╕Др╕░р╣Бр╕Щр╕Щ
    // =========================================================
    db.ref("scores").on("value", (snapshot) => {
      const data = snapshot.val() || {};

      const totals = {};
      const lateCounts = {};
      const lateHasData = {};
      const lineupTotals = {};
      const cleanTotals = {};

      FACULTIES.forEach(f => {
        totals[f] = 0;
        lateCounts[f] = 0;
        lateHasData[f] = false;
        lineupTotals[f] = 0;
        cleanTotals[f] = 0;
      });

      for (const key in data) {
        const item = data[key] || {};
        const faculty = (item.faculty || "").trim();
        if (!FACULTIES.includes(faculty)) continue;

        const val = Number(item.value) || 0;

        if (item.type === TYPE_LATE) {
          lateCounts[faculty] += val;
          lateHasData[faculty] = true;
        } else if (item.type === TYPE_LINEUP) {
          lineupTotals[faculty] += val;
        } else if (item.type === TYPE_CLEAN) {
          cleanTotals[faculty] += val;
        }
      }

      // р╕гр╕зр╕бр╕Др╕░р╣Бр╕Щр╕Щр╣Ар╕Вр╣Йр╕▓р╣Бр╕Цр╕з + р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╣Ар╕Йр╕ер╕╡р╣Ир╕вр╕Хр╕▓р╕бр╕Ир╕│р╕Щр╕зр╕Щр╕лр╣Йр╕нр╕З
      FACULTIES.forEach(f => {
        totals[f] += lineupTotals[f];
        const roomCount = CLASSROOMS[f]?.length || 0;
        totals[f] += roomCount > 0 ? (cleanTotals[f] / roomCount) : 0;
      });

      // р╕Ир╕▒р╕Фр╕нр╕▒р╕Щр╕Фр╕▒р╕Ър╕бр╕▓р╕кр╕▓р╕в + р╣Бр╕Ир╕Бр╕Др╕░р╣Бр╕Щр╕Щ 9-5 р╣Ар╕Йр╕Юр╕▓р╕░р╕Бр╕гр╕Ур╕╡р╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕бр╕▓р╕кр╕▓р╕вр╕Ир╕гр╕┤р╕З
      const sortedByLate = FACULTIES
        .map(f => [f, lateHasData[f] ? lateCounts[f] : Number.POSITIVE_INFINITY])
        .sort((a, b) => a[1] - b[1]);

      const hasAnyLateData = FACULTIES.some(f => lateHasData[f] === true);

      if (hasAnyLateData) {
        sortedByLate.forEach(([f], idx) => {
          const lateScore = LATE_RANK_SCORES[Math.min(idx, LATE_RANK_SCORES.length - 1)];
          totals[f] += lateScore;
        });
      }

      // р╕лр╕▓ winner
      let winner = null;
      let maxScore = -Infinity;
      FACULTIES.forEach(f => {
        if (totals[f] > maxScore) {
          maxScore = totals[f];
          winner = f;
        }
      });

      // тЬЕ р╕кр╕│р╕Др╕▒р╕Н: р╣Др╕бр╣Ир╣Гр╕Кр╣Й winnerBox.innerHTML р╕Чр╕▒р╕Ър╣Вр╕Др╕гр╕Зр╕нр╕╡р╕Бр╣Бр╕ер╣Йр╕з
      const winnerHero = document.getElementById("winnerHero");
      const winnerEmpty = document.getElementById("winnerEmpty");

      if (winner && isFinite(maxScore)) {
        winnerHero.style.display = "flex";
        winnerEmpty.style.display = "none";

        document.getElementById("winnerName").innerText = winner;
        document.getElementById("winnerScore").innerText = `р╕Др╕░р╣Бр╕Щр╕Щр╕гр╕зр╕б ${maxScore.toFixed(2)} р╕Др╕░р╣Бр╕Щр╕Щ`;
      } else {
        winnerHero.style.display = "none";
        winnerEmpty.style.display = "block";
      }

      // р╣Ар╕Хр╕┤р╕бр╕Хр╕▓р╕гр╕▓р╕З
      const tbody = document.querySelector("#summaryTable tbody");
      tbody.innerHTML = "";

      FACULTIES.forEach(f => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${f}</td><td>${(totals[f] || 0).toFixed(2)}</td>`;
        tbody.appendChild(row);
      });
    });
  </script>
</body>
</html>

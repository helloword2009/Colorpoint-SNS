<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>р╕кр╕гр╕╕р╕Ыр╕Ьр╕ер╕Др╕Ур╕░р╕вр╕нр╕Фр╣Ар╕вр╕╡р╣Ир╕вр╕бр╕Ыр╕гр╕░р╕Ир╕│р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣М</title>
  <link rel="stylesheet" href="styles/summary.css?v=2">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <header>
    <h1>р╕кр╕гр╕╕р╕Ыр╕Ьр╕ер╕Др╕Ур╕░р╕вр╕нр╕Фр╣Ар╕вр╕╡р╣Ир╕вр╕бр╕Ыр╕гр╕░р╕Ир╕│р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣М</h1>
  </header>

  <main>
    <div id="winnerBox" class="winner-box"></div>

    <table id="summaryTable">
      <thead>
        <tr>
          <th>р╕Др╕Ур╕░р╕кр╕╡</th>
          <th>р╕Др╕░р╣Бр╕Щр╕Щр╕гр╕зр╕б</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <footer>
    <p>┬й р╣Вр╕гр╕Зр╣Ар╕гр╕╡р╕вр╕Щр╕кр╕Хр╕гр╕╡р╕Щр╕Др╕гр╕кр╕зр╕гр╕гр╕Др╣М | <a href="dashboard.html">р╕гр╕▓р╕вр╕Зр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е</a></p>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDwmeumgDSVlspe7gIcF6rVbe-hBye7Q3I",
    authDomain: "school-scores-8e9eb.firebaseapp.com",
    databaseURL: "https://school-scores-8e9eb-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "school-scores-8e9eb",
    storageBucket: "school-scores-8e9eb.firebasestorage.app",
    messagingSenderId: "416720346956",
    appId: "1:416720346956:web:b20e84af0b635b374279e9",
    measurementId: "G-DD7E1RFNC1"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const FACULTIES = ["р╕бр╕▓р╕ер╕▒р╕вр╕Юр╕┤р╕гр╕╕р╕У","р╣Др╕Юр╕Ир╕┤р╕Хр╣Ар╕зр╕лр╕▓р╕к","р╣Вр╕нр╕ар╕▓р╕кр╕гр╕зр╕╡","р╕Ир╕▒р╕Щр╕Чр╕гр╕▓р╕нр╕│р╣Др╕Ю","р╕гр╕▒р╕ир╕бр╕╡р╕Фр╕▓р╕гр╕▓"];

  const CLASSROOMS = {
    "р╕бр╕▓р╕ер╕▒р╕вр╕Юр╕┤р╕гр╕╕р╕У": ["1/4","1/9","2/5","2/10","3/1","3/6","3/11","4/1","4/6","4/11","5/2","5/12","6/2","6/7","6/12"],
    "р╣Др╕Юр╕Ир╕┤р╕Хр╣Ар╕зр╕лр╕▓р╕к": ["1/5","1/10","2/1","2/6","2/11","3/2","3/7","3/12","4/2","4/12","5/3","5/8","6/3","6/8","6/11"],
    "р╣Вр╕нр╕ар╕▓р╕кр╕гр╕зр╕╡": ["1/1","1/6","1/11","2/2","2/7","3/3","3/8","4/3","4/8","4/13","5/4","5/9","5/11","6/4","6/9"],
    "р╕Ир╕▒р╕Щр╕Чр╕гр╕▓р╕нр╕│р╣Др╕Ю": ["1/3","1/8","1/13","2/4","2/9","3/5","3/10","4/5","4/7","4/10","5/1","5/6","6/5","6/6","6/13"],
    "р╕гр╕▒р╕ир╕бр╕╡р╕Фр╕▓р╕гр╕▓": ["1/2","1/7","1/12","2/3","2/8","2/13","3/4","3/9","4/4","4/9","5/5","5/7","5/10","5/13","6/1","6/10"]
  };

  const TYPE_LATE = "р╕Др╕░р╣Бр╕Щр╕Щр╕бр╕▓р╕кр╕▓р╕в";
  const TYPE_LINEUP = "р╕Др╕░р╣Бр╕Щр╕Щр╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╣Бр╕Цр╕з";
  const TYPE_CLEAN = "р╕Др╕░р╣Бр╕Щр╕Щр╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Ф";
  const LATE_RANK_SCORES = [9, 8, 7, 6, 5];

  // =========================
  // тЬЕ р╕кр╕гр╕╕р╕Ыр╕Др╕░р╣Бр╕Щр╕Щ (р╕Др╕│р╕Щр╕зр╕Ур╣Гр╕лр╕бр╣Ир╕Чр╕╕р╕Бр╕Др╕гр╕▒р╣Йр╕З)
  // =========================
  db.ref("scores").on("value", (snapshot) => {
    const data = snapshot.val() || {};

    const totals = {};
    const lateCounts = {};
    const lateHasData = {};
    const lineupTotals = {};
    const cleanTotals = {};

    FACULTIES.forEach(f => {
      totals[f] = 0;
      lateCounts[f] = 0;
      lateHasData[f] = false;
      lineupTotals[f] = 0;
      cleanTotals[f] = 0;
    });

    // р╕гр╕зр╕бр╕Др╕░р╣Бр╕Щр╕Щр╕Хр╕▓р╕бр╕Ыр╕гр╕░р╣Ар╕ар╕Ч
    for (const key in data) {
      const item = data[key] || {};
      const faculty = (item.faculty || "").trim();
      if (!FACULTIES.includes(faculty)) continue;

      const val = Number(item.value) || 0;

      if (item.type === TYPE_LATE) {
        lateCounts[faculty] += val;
        lateHasData[faculty] = true;
      } else if (item.type === TYPE_LINEUP) {
        lineupTotals[faculty] += val;
      } else if (item.type === TYPE_CLEAN) {
        cleanTotals[faculty] += val;
      }
    }

    // р╕Др╕░р╣Бр╕Щр╕Щр╣Ар╕Вр╣Йр╕▓р╣Бр╕Цр╕з + р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╣Ар╕Йр╕ер╕╡р╣Ир╕вр╕Хр╕▓р╕бр╕Ир╕│р╕Щр╕зр╕Щр╕лр╣Йр╕нр╕З
    FACULTIES.forEach(f => {
      totals[f] += lineupTotals[f];

      const roomCount = CLASSROOMS[f]?.length || 0;
      totals[f] += roomCount > 0 ? (cleanTotals[f] / roomCount) : 0;
    });

    // тЬЕ р╣Бр╕Ир╕Бр╕Др╕░р╣Бр╕Щр╕Щр╕бр╕▓р╕кр╕▓р╕в 9тАУ5 р╣Ар╕Йр╕Юр╕▓р╕░р╕Др╕Ур╕░р╕Чр╕╡р╣Ир╕бр╕╡ тАЬр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕бр╕▓р╕кр╕▓р╕вр╕Ир╕гр╕┤р╕ЗтАЭ
    const hasAnyLateData = FACULTIES.some(f => lateHasData[f] === true);

    if (hasAnyLateData) {
      const withLate = FACULTIES
        .filter(f => lateHasData[f] === true)
        .map(f => [f, lateCounts[f]])
        .sort((a, b) => a[1] - b[1]);

      withLate.forEach(([f], idx) => {
        const lateScore = LATE_RANK_SCORES[Math.min(idx, LATE_RANK_SCORES.length - 1)];
        totals[f] += lateScore;
      });
    }

    // р╕лр╕▓ winner
    let winner = null;
    let maxScore = -Infinity;

    FACULTIES.forEach(f => {
      const score = Number(totals[f] || 0);
      if (score > maxScore) {
        maxScore = score;
        winner = f;
      }
    });

    const winnerBox = document.getElementById("winnerBox");
    const hasAnyScoreData = Object.keys(data).length > 0;

    if (hasAnyScoreData && winner && isFinite(maxScore)) {
      winnerBox.innerHTML = `ЁЯПЖ <strong>${winner}</strong> р╣Др╕Фр╣Йр╣Ар╕Ыр╣Зр╕Щр╕Др╕Ур╕░р╕вр╕нр╕Фр╣Ар╕вр╕╡р╣Ир╕вр╕бр╕Ыр╕гр╕░р╕Ир╕│р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣М р╕Фр╣Йр╕зр╕вр╕Др╕░р╣Бр╕Щр╕Щр╕гр╕зр╕б ${maxScore.toFixed(2)} р╕Др╕░р╣Бр╕Щр╕Щ`;
    } else {
      winnerBox.innerHTML = "р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Др╕░р╣Бр╕Щр╕Щр╣Гр╕Щр╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣Мр╕Щр╕╡р╣Й";
    }

    // р╣Ар╕Хр╕┤р╕бр╕Хр╕▓р╕гр╕▓р╕З
    const tbody = document.querySelector("#summaryTable tbody");
    tbody.innerHTML = "";

    FACULTIES.forEach(f => {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${f}</td><td>${(totals[f] || 0).toFixed(2)}</td>`;
      tbody.appendChild(row);
    });
  });
</script>
</body>
</html>
